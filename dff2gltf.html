<!DOCTYPE html>
<html>
  <head>
    <title>dff2gltf</title>
    <style>
      body { margin: 0; }
      canvas { width: 100%; height: 100% }
    </style>
  </head>
  <body>
  <script src="https://threejs.org/build/three.js"></script>
  <script src="https://threejs.org/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
  <script src="glr.js"></script>
  <script>
    var container, controls;
    var camera, scene, renderer;
    var hemispheric, ambient, directional;
    init();
    animate();
    function init() {
      container = document.createElement('div');
      document.body.appendChild(container);
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      scene = new THREE.Scene();

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth/2, window.innerHeight/2, false);
      renderer.gammaOutput = true;
      renderer.setClearColor(0x222222);
      container.appendChild(renderer.domElement);

      hemispheric = new THREE.HemisphereLight(0xffffff, 0x222222, 1.2);
      scene.add(hemispheric);

      ambient = new THREE.AmbientLight(0x404040);
      scene.add(ambient);

      directional = new THREE.DirectionalLight(0x404040);
      directional.position.set(0.5, 0, 0.866);
      scene.add(directional);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.screenSpacePanning = true;
      controls.update();

      window.addEventListener('resize', onWindowResize, false);
    }
    function setup(gltf) {
      const box = new THREE.Box3().setFromObject(gltf.scene);
      const size = box.getSize(new THREE.Vector3()).length();
      const center = box.getCenter(new THREE.Vector3());

      gltf.scene.position.x += (gltf.scene.position.x - center.x);
      gltf.scene.position.y += (gltf.scene.position.y - center.y);
      gltf.scene.position.z += (gltf.scene.position.z - center.z);
      controls.maxDistance = size * 10;
      camera.near = size / 100;
      camera.far = size * 100;
      camera.updateProjectionMatrix();

      camera.position.copy(center);
      camera.position.x += size / 2.0;
      camera.position.y += size / 5.0;
      camera.position.z += size / 2.0;
      camera.lookAt(center);

      scene.add(gltf.scene);
    }
    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth/2, window.innerHeight/2, false);
    }
    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }
    function fetchAsset(asset) {
      let range = 'bytes=' + (2048 * asset.offset) + '-' + (2048 * (asset.offset + asset.size))
      return fetch('/data/models/gta3.img', { headers: { 'Range': range }})
    }
    function renderModel(dff, txd) {
      try {
        let textures = Module.loadTXD(Module.to_bytes(txd))
        let model = Module.loadDFF(Module.to_bytes(dff))
        let out = Module.printModel(model, textures)
        let gltf = glr2gltf(out)
        var loader = new THREE.GLTFLoader()
        loader.load('data:application/json,' + encodeURIComponent(JSON.stringify(gltf)), setup)
      } catch(e) {
        console.error(e)
      }
    }
    var Module = {
      printErr: function(s) {
        console.error(s)
      },
      onRuntimeInitialized: function() {
        const urlParams = new URLSearchParams(window.location.search);
        fetch('/data/models/gta3.dir').then(response => response.blob()).then(blob => blob.arrayBuffer()).then(dir => {
          try {
            let assets = Module.loadDIR(Module.to_bytes(dir))
            let assetDFF = Module.findEntry(assets, urlParams.get('dff') + '.dff')
            let assetTXD = Module.findEntry(assets, urlParams.get('txd') + '.txd')
            fetchAsset(assetDFF).then(response => response.blob()).then(blob => blob.arrayBuffer()).then(dff => {
              fetchAsset(assetTXD).then(response => response.blob()).then(blob => blob.arrayBuffer()).then(txd => {
                renderModel(dff, txd)
              })
            })
          } catch (e) {
            console.error(e)
          }
        })
      }
    }
  </script>
  <script src="dff2glr.js"></script>
  </body>
</html>
